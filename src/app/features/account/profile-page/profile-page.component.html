<!-- /src/app/features/account/profile-page/profile-page.component.html -->
<div class="profile-page-container">
  <h1>{{ 'profilePage.mainTitle' | transloco }}</h1>

  <div *ngIf="isLoading()" class="loading-indicator">
    <p>{{ 'profilePage.loadingData' | transloco }}</p>
  </div>

  <div *ngIf="errorMessage() && !isEditing()" class="error-message general-error profile-load-error">
    <p>{{ errorMessage() }}</p> <!-- Kommt schon übersetzt aus TS -->
    <a routerLink="/">{{ 'profilePage.backToHome' | transloco }}</a>
  </div>

  <ng-container *ngIf="userProfile() as profile; else noProfile">
    <div class="profile-content">

      <div class="edit-button-container">
        <button type="button" class="edit-toggle-button" (click)="toggleEditMode()">
          <span class="material-symbols-outlined">{{ isEditing() ? 'close' : 'edit' }}</span>
          {{ (isEditing() ? 'profilePage.cancelButton' : 'profilePage.editProfileButton') | transloco }}
        </button>
      </div>

      <div *ngIf="successMessage()" class="success-message">
        {{ successMessage() }} <!-- Kommt schon übersetzt aus TS -->
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" novalidate class="profile-form">

        <h2>{{ 'profilePage.personalDataTitle' | transloco }}</h2>

        <div class="form-field">
          <label for="profileEmail">{{ 'profilePage.emailLabel' | transloco }}</label>
          <input type="email" id="profileEmail" formControlName="email" readonly>
          <small class="field-hint">{{ 'profilePage.emailHint' | transloco }}</small>
        </div>

        <div class="form-field">
          <label for="profileFirstName">{{ 'profilePage.firstNameLabel' | transloco }}</label>
          <div class="display-field" *ngIf="!isEditing()">{{ profile.firstName }}</div>
          <ng-container *ngIf="isEditing()">
            <input type="text" id="profileFirstName" formControlName="firstName" required
                   [attr.aria-invalid]="firstName?.invalid && (firstName?.touched || formSubmitted())"
                   aria-describedby="firstNameError">
            <div id="firstNameError" class="error-container"
                 *ngIf="firstName?.invalid && (firstName?.touched || formSubmitted())">
              <small *ngIf="firstName?.errors?.['required']">{{ 'profilePage.errorFirstNameRequired' | transloco }}</small>
            </div>
          </ng-container>
        </div>

        <div class="form-field">
          <label for="profileLastName">{{ 'profilePage.lastNameLabel' | transloco }}</label>
          <div class="display-field" *ngIf="!isEditing()">{{ profile.lastName }}</div>
          <ng-container *ngIf="isEditing()">
            <input type="text" id="profileLastName" formControlName="lastName" required
                   [attr.aria-invalid]="lastName?.invalid && (lastName?.touched || formSubmitted())"
                   aria-describedby="lastNameError">
             <div id="lastNameError" class="error-container"
                 *ngIf="lastName?.invalid && (lastName?.touched || formSubmitted())">
              <small *ngIf="lastName?.errors?.['required']">{{ 'profilePage.errorLastNameRequired' | transloco }}</small>
            </div>
          </ng-container>
        </div>

        <h2>{{ 'profilePage.addressTitle' | transloco }}</h2>

        <div class="form-field">
           <label for="profileAddressStreet">{{ 'profilePage.addressStreetLabel' | transloco }}</label>
           <div class="display-field" *ngIf="!isEditing()">{{ profile.address.street || ('profilePage.notAvailable' | transloco) }}</div>
           <ng-container *ngIf="isEditing()">
              <input type="text" id="profileAddressStreet" formControlName="addressStreet" required
                     [attr.aria-invalid]="addressStreet?.invalid && (addressStreet?.touched || formSubmitted())"
                     aria-describedby="addressStreetError">
              <div id="addressStreetError" class="error-container"
                    *ngIf="addressStreet?.invalid && (addressStreet?.touched || formSubmitted())">
                <small *ngIf="addressStreet?.errors?.['required']">{{ 'profilePage.errorAddressStreetRequired' | transloco }}</small>
              </div>
           </ng-container>
         </div>

         <div class="form-row">
           <div class="form-field zip-field">
             <label for="profileAddressZip">{{ 'profilePage.addressZipLabel' | transloco }}</label>
             <div class="display-field" *ngIf="!isEditing()">{{ profile.address.zip || ('profilePage.notAvailable' | transloco) }}</div>
             <ng-container *ngIf="isEditing()">
                <input type="text" id="profileAddressZip" formControlName="addressZip" required inputmode="numeric"
                      [attr.aria-invalid]="addressZip?.invalid && (addressZip?.touched || formSubmitted())"
                      aria-describedby="addressZipError">
                <div id="addressZipError" class="error-container"
                      *ngIf="addressZip?.invalid && (addressZip?.touched || formSubmitted())">
                  <small *ngIf="addressZip?.errors?.['required']">{{ 'profilePage.errorAddressZipRequired' | transloco }}</small>
                  <small *ngIf="addressZip?.errors?.['pattern']">{{ 'profilePage.errorAddressZipPattern' | transloco }}</small>
                </div>
             </ng-container>
           </div>
           <div class="form-field city-field">
             <label for="profileAddressCity">{{ 'profilePage.addressCityLabel' | transloco }}</label>
             <div class="display-field" *ngIf="!isEditing()">{{ profile.address.city || ('profilePage.notAvailable' | transloco) }}</div>
             <ng-container *ngIf="isEditing()">
                <input type="text" id="profileAddressCity" formControlName="addressCity" required
                      [attr.aria-invalid]="addressCity?.invalid && (addressCity?.touched || formSubmitted())"
                      aria-describedby="addressCityError">
                <div id="addressCityError" class="error-container"
                      *ngIf="addressCity?.invalid && (addressCity?.touched || formSubmitted())">
                  <small *ngIf="addressCity?.errors?.['required']">{{ 'profilePage.errorAddressCityRequired' | transloco }}</small>
                </div>
             </ng-container>
           </div>
         </div>

         <h2>{{ 'profilePage.settingsTitle' | transloco }}</h2>

         <div class="form-field checkbox-field">
             <input type="checkbox" id="profileNewsletter" formControlName="newsletter">
             <label for="profileNewsletter">
                 {{ 'profilePage.newsletterLabel' | transloco }}
                 <span *ngIf="!isEditing()"> ({{ 'profilePage.statusLabel' | transloco }}: {{ profile.newsletterSubscribed ? ('profilePage.subscribed' | transloco) : ('profilePage.notSubscribed' | transloco) }})</span>
             </label>
         </div>

         <div class="form-field">
            <label>{{ 'profilePage.passwordLabel' | transloco }}</label>
            <div class="display-field" *ngIf="!isEditing()">********</div>
             <ng-container *ngIf="isEditing()">
                 <button type="button" class="change-password-button" disabled>{{ 'profilePage.changePasswordButton' | transloco }}</button>
                 <small class="field-hint">{{ 'profilePage.changePasswordHint' | transloco }}</small>
             </ng-container>
         </div>

        <div *ngIf="errorMessage() && isEditing()" class="error-message general-error profile-save-error">
          {{ errorMessage() }} <!-- Kommt schon übersetzt aus TS -->
        </div>

        <div class="action-button-container" *ngIf="isEditing()">
          <button type="submit" class="submit-button" [disabled]="profileForm.invalid || isSaving()">
            <span *ngIf="!isSaving()">{{ 'profilePage.saveChangesButton' | transloco }}</span>
            <span *ngIf="isSaving()" class="button-loading-spinner"></span>
            <span *ngIf="isSaving()">{{ 'profilePage.savingButton' | transloco }}</span>
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <ng-template #noProfile>
    <p *ngIf="!isLoading() && !errorMessage()">
       {{ 'profilePage.profileNotAvailable' | transloco }}
    </p>
  </ng-template>
</div>