<div class="product-page-content">
  <!-- === NEU: Zurück-Button === -->
  <button class="back-button icon-button" (click)="goBack()" title="Zurück">
    <span class="material-symbols-outlined">arrow_back</span>
    <span>Zurück</span>
  </button>
  <!-- === ENDE Zurück-Button === -->

  <div *ngIf="isLoading()" class="loading-indicator"><p>Lade Produktdetails...</p></div>
  <div *ngIf="error()" class="error-message general-error product-load-error">
     <p>{{ error() }}</p>
     <a routerLink="/">Zurück zur Startseite</a>
  </div>

  <ng-container *ngIf="product() as productData">
    <div class="product-detail-container">
      <div class="product-main-grid">
        <div class="product-media-gallery">
          <div class="main-image-container" *ngIf="selectedImage() as mainImg">
            <img [src]="mainImg.url" [alt]="mainImg.altText ?? productData.title">
          </div>
           <div class="main-image-container" *ngIf="!selectedImage() && !productData.images?.edges?.[0]?.node">
              <div class="no-image-placeholder"><span class="material-symbols-outlined">image</span></div>
           </div>
          <div class="thumbnail-container" *ngIf="productData.images?.edges && productData.images.edges.length > 1">
              <div class="thumbnail" *ngFor="let edge of productData.images.edges; let i = index"
                   (click)="selectImage(edge.node)"
                   [class.selected]="selectedImage()?.url === edge.node.url">
                <img [src]="edge.node.url | imageTransform : 100 : 100"
                     [alt]="edge.node.altText || 'Thumbnail ' + (i + 1)">
              </div>
          </div>
        </div>

        <div class="product-info">
          <h1>{{ productData.title }}</h1>
          <div class="price-section" *ngIf="productData.variants?.edges?.[0]?.node?.price as variantPrice">
              <span class="current-price">
                {{ variantPrice.amount | formatPrice : variantPrice.currencyCode }}
              </span>
          </div>
          <div class="availability-section" *ngIf="productData.variants?.edges?.[0]?.node as firstVariant">
            <span [class.in-stock]="firstVariant.availableForSale" [class.out-of-stock]="!firstVariant.availableForSale">
              {{ firstVariant.availableForSale ? 'Auf Lager' : 'Nicht verfügbar' }}
            </span>
          </div>
           <div class="action-buttons-section" *ngIf="productData.variants?.edges?.[0]?.node as firstVariant">
            <button class="add-to-cart-btn action-button" (click)="addToCart()"
              [disabled]="!firstVariant.availableForSale || isAddingToCart()">
              <span class="material-symbols-outlined" *ngIf="!isAddingToCart()">add_shopping_cart</span>
              <span *ngIf="!isAddingToCart()">In den Warenkorb</span>
               <span *ngIf="isAddingToCart()" class="button-loading-spinner"></span>
               <span *ngIf="isAddingToCart()">Wird hinzugefügt...</span>
            </button>
            <button class="add-to-wishlist-btn action-button" (click)="toggleWishlist()"
                    [title]="isOnWishlist() ? 'Von Wunschliste entfernen' : 'Zur Wunschliste hinzufügen'">
              <span *ngIf="!isOnWishlist()" class="material-symbols-outlined wishlist-icon">favorite_border</span>
              <span *ngIf="isOnWishlist()" class="material-symbols-outlined wishlist-icon filled">favorite</span>
            </button>
          </div>
          <div *ngIf="addToCartError()" class="error-message general-error cart-error"> {{ addToCartError() }} </div>
          <div class="description-section">
            <h3>Beschreibung</h3>
            <div *ngIf="productData.descriptionHtml" [innerHTML]="productData.descriptionHtml | safeHtml"></div>
            <p *ngIf="!productData.descriptionHtml">Keine Beschreibung verfügbar.</p>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
  <p *ngIf="!isLoading() && !product() && !error()">
    Das angeforderte Produkt konnte nicht gefunden werden.
  </p>
</div>