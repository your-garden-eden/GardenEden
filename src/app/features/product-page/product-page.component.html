<!-- /src/app/features/product-page/product-page.component.html -->
<div class="product-page-content">
  <!-- Zurück-Button -->
  <button class="back-button icon-button" (click)="goBack()" title="Zurück">
    <span class="material-symbols-outlined">arrow_back</span>
    <span>Zurück</span>
  </button>

  <!-- Ladezustand -->
  @if (isLoading()) {
    <div class="loading-indicator"><p>Lade Produktdetails...</p></div>
  }

  <!-- Fehlerzustand -->
  @if (error(); as errorMsg) {
    <div class="error-message general-error product-load-error">
      <p>{{ errorMsg }}</p>
      <a routerLink="/">Zurück zur Startseite</a>
    </div>
  }

  <!-- Hauptinhalt, wenn Produkt geladen wurde -->
  @if (product(); as productData) {
    <div class="product-detail-container">
      <div class="product-main-grid">

        <!-- Bildergalerie (Links) -->
        <div class="product-media-gallery">
          <!-- Hauptbild -->
          @if (selectedImage(); as mainImg) {
            <div class="main-image-container">
              <img [src]="mainImg.url" [alt]="mainImg.altText ?? productData.title">
            </div>
          } @else if (!productData.images.edges?.[0]?.node) { <!-- Korrigiert -->
            <!-- Placeholder wenn gar kein Bild da -->
            <div class="main-image-container">
               <div class="no-image-placeholder"><span class="material-symbols-outlined">image</span></div>
            </div>
          }

          <!-- Thumbnails (nur wenn mehr als 1 Bild) -->
          @if (productData.images.edges && productData.images.edges.length > 1) { <!-- Korrigiert -->
            <div class="thumbnail-container">
              @for (edge of productData.images.edges; track edge.node.url) { <!-- Korrigiert -->
                <div class="thumbnail"
                     (click)="selectImage(edge.node)"
                     [class.selected]="selectedImage()?.url === edge.node.url">
                  <img [src]="edge.node.url | imageTransform : 100 : 100"
                       [alt]="edge.node.altText || 'Thumbnail ' + ($index + 1)"> <!-- Korrigiert -->
                </div>
              }
            </div>
          }
        </div>

        <!-- Produktinformationen (Rechts) -->
        <div class="product-info">
          <h1>{{ productData.title }}</h1>

          <!-- Preis -->
          @if (productData.variants.edges?.[0]?.node?.price; as variantPrice) { <!-- Korrigiert -->
            <div class="price-section">
              <span class="current-price">
                {{ variantPrice.amount | formatPrice : variantPrice.currencyCode }}
              </span>
            </div>
          }

          <!-- Verfügbarkeit & Buttons -->
          @if (productData.variants.edges?.[0]?.node; as firstVariant) { <!-- Korrigiert -->
            <div class="availability-section">
              <span [class.in-stock]="firstVariant.availableForSale"
                    [class.out-of-stock]="!firstVariant.availableForSale">
                {{ firstVariant.availableForSale ? 'Auf Lager' : 'Nicht verfügbar' }}
              </span>
            </div>

            <!-- Aktionsbuttons -->
            <div class="action-buttons-section">
              <!-- In den Warenkorb Button -->
              <button class="add-to-cart-btn action-button"
                      (click)="addToCart()"
                      [disabled]="!firstVariant.availableForSale || isAddingToCart()">
                @if (!isAddingToCart()) {
                  <span class="material-symbols-outlined">add_shopping_cart</span>
                  <span>In den Warenkorb</span>
                } @else {
                  <span class="button-loading-spinner"></span>
                  <span>Wird hinzugefügt...</span>
                }
              </button>

              <!-- *** Wunschliste Button (HIER EINGEFÜGT) *** -->
              <button class="add-to-wishlist-btn action-button"
                      (click)="toggleWishlist()"
                      [disabled]="!isLoggedIn()"
                      [title]="!isLoggedIn() ? 'Bitte anmelden' : (isOnWishlist() ? 'Von Wunschliste entfernen' : 'Zur Wunschliste hinzufügen')">
                 <span class="material-symbols-outlined wishlist-icon" [class.filled]="isOnWishlist()">
                     {{ isOnWishlist() ? 'favorite' : 'favorite_border' }}
                 </span>
              </button>
              <!-- *** ENDE WUNSCHLISTEN-BUTTON *** -->

            </div> <!-- Ende action-buttons-section -->

             <!-- Fehler beim Hinzufügen zum Warenkorb -->
             @if (addToCartError()) {
                <div class="error-message general-error cart-error">{{ addToCartError() }}</div>
             }

          } <!-- Ende @if firstVariant für Buttons -->

          <!-- Beschreibung -->
          <div class="description-section">
            <h3>Beschreibung</h3>
            @if (productData.descriptionHtml) {
              <div [innerHTML]="productData.descriptionHtml | safeHtml"></div>
            } @else {
              <p>Keine Beschreibung verfügbar.</p>
            }
          </div>

        </div> <!-- Ende product-info -->
      </div> <!-- Ende product-main-grid -->
    </div> <!-- Ende product-detail-container -->
  }
  <!-- Meldung, wenn Produkt nicht gefunden wurde -->
  @else if (!isLoading() && !error()) {
    <p class="not-found-message">Das angeforderte Produkt konnte nicht gefunden werden.</p>
  }
</div> <!-- Ende product-page-content -->