<!-- /src/app/features/product-page/product-page.component.html -->
<div class="product-page-content">
  <button class="back-button icon-button" (click)="goBack()" [title]="'productPage.backButton' | transloco">
    <span class="material-symbols-outlined">arrow_back</span>
    <span>{{ 'productPage.backButton' | transloco }}</span>
  </button>

  @if (isLoading()) {
    <div class="loading-indicator"><p>{{ 'productPage.loadingDetails' | transloco }}</p></div>
  }

  @if (error(); as errorMsg) {
    <div class="error-message general-error product-load-error">
      <p>{{ errorMsg }}</p> <!-- errorMsg kommt bereits übersetzt aus dem TS -->
      <a routerLink="/">{{ 'productPage.backToHome' | transloco }}</a>
    </div>
  }

  @if (product(); as productData) {
    <div class="product-detail-container">
      <div class="product-main-grid">

        <div class="product-media-gallery">
          @if (selectedImage(); as mainImg) {
            <div class="main-image-container">
              <img [src]="mainImg.url" [alt]="mainImg.altText ?? productData.title">
            </div>
          } @else if (!productData.images.edges?.[0]?.node) {
            <div class="main-image-container">
               <div class="no-image-placeholder"><span class="material-symbols-outlined" [title]="'productPage.noImageAvailable' | transloco">image</span></div>
            </div>
          }

          @if (productData.images.edges && productData.images.edges.length > 1) {
            <div class="thumbnail-container">
              @for (edge of productData.images.edges; track edge.node.url; let i = $index) {
                <div class="thumbnail"
                     (click)="selectImage(edge.node)"
                     [class.selected]="selectedImage()?.url === edge.node.url">
                  <img [src]="edge.node.url | imageTransform : 100 : 100"
                       [alt]="edge.node.altText || ('productPage.thumbnailAlt' | transloco: { index: i + 1 })">
                </div>
              }
            </div>
          }
        </div>

        <div class="product-info">
          <h1>{{ productData.title }}</h1>

          @if (productData.variants.edges?.[0]?.node?.price; as variantPrice) {
            <div class="price-section">
              <span class="current-price">
                {{ variantPrice.amount | formatPrice : variantPrice.currencyCode }}
              </span>
            </div>
          }

          @if (productData.variants.edges?.[0]?.node; as firstVariant) {
            <div class="availability-section">
              <span [class.in-stock]="firstVariant.availableForSale"
                    [class.out-of-stock]="!firstVariant.availableForSale">
                {{ firstVariant.availableForSale ? ('productPage.availability.inStock' | transloco) : ('productPage.availability.outOfStock' | transloco) }}
              </span>
            </div>

            <div class="action-buttons-section">
              <button class="add-to-cart-btn action-button"
                      (click)="addToCart()"
                      [disabled]="!firstVariant.availableForSale || isAddingToCart()">
                @if (!isAddingToCart()) {
                  <span class="material-symbols-outlined">add_shopping_cart</span>
                  <span>{{ 'productPage.actions.addToCart' | transloco }}</span>
                } @else {
                  <span class="button-loading-spinner"></span>
                  <span>{{ 'productPage.actions.addingToCart' | transloco }}</span>
                }
              </button>

              <button class="add-to-wishlist-btn action-button"
                      (click)="toggleWishlist()"
                      [disabled]="!isLoggedIn()"
                      [title]="!isLoggedIn() ? ('productPage.actions.wishlistLogin' | transloco) : (isOnWishlist() ? ('productPage.actions.removeFromWishlist' | transloco) : ('productPage.actions.addToWishlist' | transloco))">
                 <span class="material-symbols-outlined wishlist-icon" [class.filled]="isOnWishlist()">
                     {{ isOnWishlist() ? 'favorite' : 'favorite_border' }}
                 </span>
              </button>

            </div>

             @if (addToCartError()) { <!-- addToCartError kommt bereits übersetzt aus dem TS -->
                <div class="error-message general-error cart-error">{{ addToCartError() }}</div>
             }
          }

          <div class="description-section">
            <h3>{{ 'productPage.description.title' | transloco }}</h3>
            @if (productData.descriptionHtml) {
              <div [innerHTML]="productData.descriptionHtml | safeHtml"></div>
            } @else {
              <p>{{ 'productPage.description.none' | transloco }}</p>
            }
          </div>

        </div>
      </div>
    </div>
  }
  @else if (!isLoading() && !error()) { <!-- error() kommt bereits übersetzt aus dem TS -->
    <p class="not-found-message">{{ 'productPage.notFoundMessage' | transloco }}</p>
  }
</div>