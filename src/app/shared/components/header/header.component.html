<!-- /src/app/shared/components/header/header.component.html -->
<header class="app-header two-rows">
  <div class="top-row">
    <button id="hamburger-button" class="icon-button hamburger-button"
            (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen"
            aria-label="Menü öffnen/schließen" [attr.aria-expanded]="isMobileMenuOpen">
      <span class="material-symbols-outlined">menu</span>
    </button>

    <div class="search-bar-container">
      <div class="search-input-wrapper">
        <span class="material-symbols-outlined search-icon-prefix">search</span>
        <input type="text" id="search-query" placeholder="Produkte suchen..."
               [formControl]="searchControl"
               (focus)="isSearchOverlayVisible.set(true)"
               autocomplete="off">
        @if(searchControl.value) {
          <button class="icon-button clear-button" (click)="clearSearch()" aria-label="Suche leeren">
            <span class="material-symbols-outlined">close</span>
          </button>
        }
      </div>

      @if(isSearchOverlayVisible()) {
        <div class="search-results-overlay">
          @if(isSearchLoading()) {
            <div class="search-loading">Suche läuft...</div>
          } @else if (searchError()) {
              <div class="search-error">{{searchError()}}</div>
          } @else if (searchResults().length > 0) {
            <ul>
              @for(product of searchResults(); track product.id) {
                <li>
                  <a [routerLink]="['/product', product.handle]" (click)="onSearchResultClick()" class="search-result-item">
                    @if(product.images.edges?.[0]?.node?.url) {
                      <img [src]="product.images.edges[0].node.url" [alt]="product.title" width="40" height="40">
                    } @else {
                      <div class="search-result-placeholder-img"></div>
                    }
                    <span class="search-result-title">{{ product.title }}</span>
                  </a>
                </li>
              }
            </ul>
          } @else if (searchControl.value && searchControl.value.length > 2 && !isSearchLoading() && !searchError()) {
              <div class="search-no-results">Keine Produkte gefunden für "{{searchControl.value}}".</div>
          } @else if (searchControl.value && searchControl.value.length <= 2) {
              <div class="search-prompt">Bitte mindestens 3 Zeichen eingeben.</div>
          }
        </div>
      }
    </div>

    <div class="user-actions">
      <!-- WUNSCHLISTEN-BUTTON -->
      <a routerLink="/wunschliste"
         [title]="(isLoggedIn$ | async) ? ((isWishlistEmpty() ? 'Zur Wunschliste (leer)' : 'Meine Wunschliste')) : 'Bitte anmelden, um Wunschliste zu nutzen'"
         class="icon-button wishlist-button"
         [class.disabled]="!(isLoggedIn$ | async)"
         [class.active]="(isLoggedIn$ | async) && !isWishlistEmpty()">
        <span class="material-symbols-outlined">
          {{ (isLoggedIn$ | async) && !isWishlistEmpty() ? 'favorite' : 'favorite_border' }}
        </span>
      </a>

      <!-- WARENKORB-BUTTON -->
      <a routerLink="/warenkorb" title="Warenkorb" class="icon-button cart-button"
         (mouseenter)="onCartIconMouseEnter()" (mouseleave)="onCartIconMouseLeave()">
        <span class="material-symbols-outlined">shopping_cart</span>
        @if (itemCount$() > 0) {
          <span class="cart-badge">{{ itemCount$() }}</span>
        }
      </a>
      <app-mini-cart *ngIf="isMiniCartOpen$()"></app-mini-cart>


      <!-- KONTO/LOGIN BUTTONS -->
      @if (currentUser$ | async; as user) {
        <a routerLink="/mein-konto" title="Mein Konto" class="icon-button account-button">
          <span class="material-symbols-outlined">person</span>
        </a>
        <button title="Abmelden" class="icon-button logout-button-desktop" (click)="performLogout()">
          <span class="material-symbols-outlined">logout</span>
        </button>
      } @else {
        <button type="button" title="Anmelden / Registrieren" class="icon-button login-button"
           (click)="toggleLoginOverlay($event)">
          <span class="material-symbols-outlined">person_outline</span>
        </button>
      }
    </div>
  </div>

  <nav class="main-nav bottom-row" [class.mobile-menu-active]="isMobileMenuOpen">
    <div class="logo-container">
      <a routerLink="/" title="Zur Startseite" (click)="closeMobileMenu()">
        <img src="assets/icons/Logo.png" alt="Your Garden Eden Logo" class="logo">
      </a>
    </div>
    <ul class="desktop-nav-list">
      @for (item of navItems; track item.label) {
        <li class="nav-item" [class.has-submenu]="item.subItems && item.subItems.length > 0">
          <a [routerLink]="item.link" routerLinkActive="active-link" [routerLinkActiveOptions]="{exact: item.link === '/'}">{{ item.label }}</a>
          @if (item.subItems && item.subItems.length > 0) {
            <ul class="submenu">
              @for (child of item.subItems; track child.label) {
                <li><a [routerLink]="child.link" routerLinkActive="active-link">{{ child.label }}</a></li>
              }
            </ul>
          }
        </li>
      }
    </ul>

    <div class="mobile-menu-overlay" (click)="closeMobileMenu()"></div>
    <div class="mobile-menu-panel">
       <button class="icon-button close-mobile-menu-button" (click)="closeMobileMenu()" aria-label="Menü schließen">
         <span class="material-symbols-outlined">close</span>
       </button>
       <ul class="mobile-nav-list">
          @for (item of navItems; track item.label) {
            <li class="mobile-nav-item">
              <div class="mobile-nav-item-content">
                 <a [routerLink]="item.link"
                    [class.main-category-link]="true"
                    routerLinkActive="active-link"
                    [routerLinkActiveOptions]="{exact: item.link === '/'}"
                    (click)="!item.subItems ? closeMobileMenu() : null">{{ item.label }}</a>
                 @if (item.subItems && item.subItems.length > 0) {
                    <button class="icon-button expand-button" (click)="toggleSubmenu(item)" [attr.aria-expanded]="item.isExpanded">
                      <span class="material-symbols-outlined"> {{ item.isExpanded ? 'expand_less' : 'expand_more' }} </span>
                    </button>
                 }
              </div>
              @if (item.subItems && item.subItems.length > 0 && item.isExpanded) {
                <ul class="mobile-submenu">
                   @for (child of item.subItems; track child.label) {
                     <li><a [routerLink]="child.link" routerLinkActive="active-link" (click)="closeMobileMenu()">{{ child.label }}</a></li>
                   }
                </ul>
              }
            </li>
          }
          @if (currentUser$ | async; as user) {
            <li class="mobile-nav-item auth-links-mobile">
              <div class="mobile-nav-item-content"> <a routerLink="/mein-konto" (click)="closeMobileMenu()" class="main-category-link">Mein Konto</a> </div>
            </li>
            <li class="mobile-nav-item auth-links-mobile">
              <div class="mobile-nav-item-content"> <button class="logout-button-mobile main-category-link" (click)="performLogout()">Abmelden</button> </div>
            </li>
          } @else {
            <li class="mobile-nav-item auth-links-mobile">
              <div class="mobile-nav-item-content"> <button class="main-category-link" (click)="toggleLoginOverlay(); closeMobileMenu()">Anmelden</button> </div>
            </li>
            <li class="mobile-nav-item auth-links-mobile">
              <div class="mobile-nav-item-content"> <a routerLink="/register" (click)="closeMobileMenu()" class="main-category-link">Registrieren</a> </div>
            </li>
          }
       </ul>
    </div>
  </nav>
</header>