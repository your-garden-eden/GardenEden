<!-- /src/app/shared/components/mini-cart/mini-cart.component.html -->
<div class="mini-cart-container"
     (mouseenter)="cancelTimeout()"
     (mouseleave)="startTimeout()">

  <div class="mini-cart-header">
    <h3>{{ 'miniCart.title' | transloco }}</h3>
    <button class="close-button icon-button" (click)="closeCart()" [attr.aria-label]="'miniCart.closeButtonAria' | transloco">
      <span class="material-symbols-outlined">close</span>
    </button>
  </div>

  @if (error(); as errorMsg) {
    <div class="error-message">
      {{ errorMsg }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading-indicator">
      <p>{{ 'miniCart.updating' | transloco }}</p>
    </div>
  }

  <div class="mini-cart-content" *ngIf="!isLoading() && !error()">
    @if (items().length > 0) {
      <ul class="cart-item-list">
        @for (item of items(); track item.key) {
          <li class="cart-item">
            <div class="item-image">
              <!-- Annahme: getProductLinkForItem und getProductImageForItem liefern korrekte Werte -->
              <a [routerLink]="getProductLinkForItem(item)" (click)="closeCart()">
                @if (getProductImageForItem(item); as imageUrl) {
                  <img [src]="imageUrl" [alt]="item.name" loading="lazy" />
                } @else {
                  <div class="no-image-placeholder small">
                    <span class="material-symbols-outlined" [title]="'productPage.noImageAvailable' | transloco">image</span>
                  </div>
                }
              </a>
            </div>
            <div class="item-details">
              <a [routerLink]="getProductLinkForItem(item)" class="item-title" (click)="closeCart()">
                {{ item.name }}
                <!-- Variantenanzeige, falls vorhanden und gewÃ¼nscht -->
                @if (item.variation && item.variation.length > 0) {
                  <span class="item-variant-title">
                    @for (variant of item.variation; track variant.attribute) {
                      <span>{{ variant.attribute }}: {{ variant.value }}</span>
                    }
                  </span>
                }
              </a>
              <!-- Preis des einzelnen Items (Preis * Menge) - kommt von item.totals.line_total -->
              <span class="item-price">
                 {{ item.totals.line_total | formatPrice : item.totals.currency_code }}
              </span>
            </div>
            <div class="item-actions">
              <div class="quantity-control">
                <button class="quantity-btn minus"
                        (click)="decreaseQuantity(item.key, item.quantity)"
                        [disabled]="isLoading()"
                        [attr.aria-label]="'miniCart.decreaseQuantityAria' | transloco">
                  <span class="material-symbols-outlined">remove</span>
                </button>
                <span class="quantity-value">{{ item.quantity }}</span>
                <button class="quantity-btn plus"
                        (click)="increaseQuantity(item.key, item.quantity)"
                        [disabled]="isLoading()"
                        [attr.aria-label]="'miniCart.increaseQuantityAria' | transloco">
                  <span class="material-symbols-outlined">add</span>
                </button>
              </div>
            </div>
          </li>
        }
      </ul>
    } @else {
      <p class="empty-cart-message">{{ 'miniCart.emptyMessage' | transloco }}</p>
    }
  </div>

  @if (!error() && items().length > 0) {
    <div class="mini-cart-footer">
      <div class="subtotal">
        <span>{{ 'miniCart.subtotalLabel' | transloco }}:</span>
        @if (subtotalData(); as subtotal) {
          <span class="subtotal-amount">
            {{ subtotal.amount | formatPrice : subtotal.currencyCode }}
          </span>
        } @else {
          <span class="subtotal-amount">...</span>
        }
      </div>
      <button class="checkout-button"
              (click)="goToCheckout()"
              [disabled]="isLoading() || items().length === 0">
        {{ 'miniCart.checkoutButton' | transloco }}
      </button>
       <a routerLink="/warenkorb" class="view-cart-link" (click)="closeCart()">{{ 'miniCart.viewCartLink' | transloco }}</a>
    </div>
  }
</div>